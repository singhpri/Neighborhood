<!DOCTYPE html>
<html>

<head>
    <script type='text/javascript' src='bower_components/knockout/dist/knockout.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <style type="text/css">
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            bottom: 0px;
            height: 100%;
            left: 300px;
            position: absolute;
            right: 0px;
        }

        .container {
            height: 100%;
            position: relative;
        }

        h1 {
            color: gray;
            font-size: 22px;
            margin: 0 0 10px 0;
            text-align: left;
        }

        #pano {
            width: 200px;
            height: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Preschools</h1>
        <div id="map"></div>
        <button id="getInfo"></button>
        <input type="text" id="myInput" placeholder="Search for names..">
        <button data-bind="click: mySchools">Filter</button>
        <ul data-bind="foreach: school">
            <li data-bind="visible: flag()">
                <span data-bind="text: name, click: $parent.getMarker"></span>
            </li>
        </ul>
    </div>

    <script>
        var map, schoolInfoWindow;
        var markers = [];
        var positions = [];
        /*{
                        title: 'Bright Horizons',
                        location: {
                            lat: 47.639159,
                            lng: -122.142314
                        }
                    },
                    {
                        title: 'Childtime of Redmond',
                        location: {
                            lat: 47.648688,
                            lng: -122.129937
                        }
                    },
                    {
                        title: 'La Petite Academy',
                        location: {
                            lat: 47.679538,
                            lng: -122.126500
                        }
                    },
                    {
                        title: 'Overlake KinderCare',
                        location: {
                            lat: 47.628773,
                            lng: -122.137012
                        }
                    },
                    {
                        title: "Anny's Care",
                        location: {
                            lat: 47.661411,
                            lng: -122.142154
                        }
                    },
                    {
                        title: "The Goddard School",
                        location: {
                            lat: 47.692930,
                            lng: -122.036428
                        }
                    },
                    {
                        title: "Education Hill Learning Center",
                        location: {
                            lat: 47.693148,
                            lng: -122.103015
                        }
                    }
                ]*/


        /*  var settings = {
            "async": true,
            "crossDomain": true,
            "url": "https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?term=preschool&latitude=47.673988&longitude=-122.121513",
            "method": "GET",
            "headers": {
                "authorization": "Bearer 9Pj--SWAuGOfObtpCllU8T60Idpse7ne3XxjHrL98T_uJEZa1u7zgcA6QkMxxzKUmAQ00Ty_cSiL1i-nQBVN-iQ6Gyt0LYzj-uLvaJwgSeP0VZhRfAvo6BYg2Qu8WXYx",
                "cache-control": "no-cache",
                "postman-token": "32cb1a94-c6ab-901c-1d58-b4594d656e8d"
            }
        }

        $.ajax(settings).done(function(data) {
         //console.log(data);
         var title, location;
         var schoolItem;

           for(var i=0; i<data.businesses.length; i++){
             title = data.businesses[i].name;
             location = data.businesses[i].coordinates;
             schoolItem = {title, location};
             positions.push(schoolItem);

       }
     });*/
        var request = $.ajax({
            "async": true,
            "crossDomain": true,
            "url": "https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search?term=preschool&latitude=47.673988&longitude=-122.121513",
            "method": "GET",
            "headers": {
                "authorization": "Bearer 9Pj--SWAuGOfObtpCllU8T60Idpse7ne3XxjHrL98T_uJEZa1u7zgcA6QkMxxzKUmAQ00Ty_cSiL1i-nQBVN-iQ6Gyt0LYzj-uLvaJwgSeP0VZhRfAvo6BYg2Qu8WXYx",
                "cache-control": "no-cache",
                "postman-token": "32cb1a94-c6ab-901c-1d58-b4594d656e8d"
            }
        })
        request.done(function(data) {
            //console.log(data);

            var title, location;
            var schoolItem;

            for (var i = 0; i < data.businesses.length; i++) {
                title = data.businesses[i].name;
                location = data.businesses[i].coordinates;
                schoolItem = {
                    title,
                    location
                };
                positions.push(schoolItem);
            }
            //it shows all the data
            console.log(positions.length);

        });
        request.fail(function() {
            alert("error");
        });
        //it goes empty HERE
        if (positions.length > 0) {
            console.log(positions.length);
        } else {
            console.log("empty");
        }

        function initMap() {

            var redmond = {
                lat: 47.673988,
                lng: -122.121513
            };
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: redmond
            });
            schoolInfoWindow = new google.maps.InfoWindow();

            for (var i = 0; i < positions.length; i++) {
                var marker = new google.maps.Marker({
                    position: positions[i].location,
                    title: positions[i].title,
                    map: map
                });
                markers.push(marker);
                marker.addListener('click', function() {
                    moreInfo(this, schoolInfoWindow);
                });

            }

        }

        function moreInfo(marker, infowindow) {
            infowindow.marker = marker;
            var service = new google.maps.StreetViewService();
            var radius = 50;

            function processData(data, status) {
                if (status == google.maps.StreetViewStatus.OK) {
                    var nearStreetViewLocation = data.location.latLng;
                    infowindow.setContent('<div>' + marker.title + '</div><div id="pano"></div><div id="yelpInfo"></div>');
                    var panorama = new google.maps.StreetViewPanorama(
                        document.getElementById('pano'), {
                            position: nearStreetViewLocation,
                            pov: {
                                heading: 270,
                                pitch: 0
                            }
                        });
                } else {
                    infowindow.setContent('<div>' + marker.title + '</div><div>The image is not found.</div>')
                }

            }

            service.getPanoramaByLocation(marker.position, radius, processData);
            infowindow.open(map, marker);
        }

        function schoolList(name, flag) {
            var self = this;
            self.name = name;
            self.flag = ko.observable(flag);
        }

        function listViewModel() {
            var self = this;
            self.school = ko.observableArray([]);
            for (var i = 0; i < positions.length; i++) {
                self.school.push(new schoolList(positions[i].title, true));
            }

            self.mySchools = function() {
                var input = document.getElementById('myInput');
                var filter = input.value.toLowerCase();
                for (var i = 0; i < self.school().length; i++) {
                    if (self.school()[i].name.toLowerCase().indexOf(filter) > -1) {
                        self.school()[i].flag(true);
                        markers[i].setMap(map);
                    } else {
                        self.school()[i].flag(false);
                        markers[i].setMap(null);
                    }
                }
            }
            self.getMarker = function(ident) {
                var infoOnSchool;
                for (var i = 0; i < markers.length; i++) {
                    if (markers[i].title === ident.name) {
                        infoOnSchool = markers[i];

                        return moreInfo(infoOnSchool, schoolInfoWindow);
                    }
                }
            }
        }
        ko.applyBindings(new listViewModel());
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBhEB5wCvm-NdmMI_G53GoFvtVGnzZe-0A&v=3&libraries=geometry&callback=initMap">
    </script>

</body>

</html>
